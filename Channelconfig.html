<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IoT Channel Config Editor</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .controls { margin-bottom: 10px; }
    .controls input, .controls button { margin-right: 5px; }
    .container { overflow-x: auto; max-height: 70vh; margin-bottom: 10px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 5px; text-align: left; }
    input[type="text"] { width: 100%; box-sizing: border-box; }
    textarea { width: 100%; height: 120px; }
  </style>
</head>
<body>
  <h1>IoT Channel Configuration Editor</h1>
  <div class="controls">
    <input type="file" id="fileInput" accept=".log" onchange="importConfig(event)">
    <button onclick="exportConfig()">Export to Textarea</button>
    <button onclick="downloadConfig()">Download .log File</button>
  </div>
  <div class="container">
    <table id="configTable">
      <thead><tr id="headerRow"></tr></thead>
      <tbody id="configBody"></tbody>
    </table>
  </div>
  <textarea id="output" placeholder="File content or exported config..."></textarea>

  <script>
    // Mapping parameter numbers to field names
    const paramMap = {
      1:'name',2:'enable',3:'type',4:'report',5:'srcreg',6:'scroll',
      7:'delta',8:'deltadeb',9:'pump',20:'prec',21:'units',
      30:'bitnum',31:'zerolabel',32:'onelabel',98:'id'
    };
    const allParams = Object.values(paramMap);

    // Build table header
    function buildHeader() {
      const header = document.getElementById('headerRow');
      header.innerHTML = '<th>Channel</th>' + allParams.map(p => `<th>${p}</th>`).join('');
    }

    // Render a table row for a channel
    function renderRow(channel, data) {
      const tbody = document.getElementById('configBody');
      const tr = document.createElement('tr');
      tr.dataset.chan = channel;
      let html = `<td>${channel}</td>`;
      allParams.forEach(key => {
        const val = data[key] || '';
        html += `<td><input type="text" data-chan="${channel}" data-param="${key}" value="${val}"></td>`;
      });
      tr.innerHTML = html;
      tbody.appendChild(tr);
    }

    // Import configuration from .log file
    function importConfig(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        const text = reader.result;
        document.getElementById('output').value = text; // show raw
        const lines = text.split(/\r?\n/);
        const tbody = document.getElementById('configBody');
        tbody.innerHTML = '';
        lines.forEach(line => {
          const t = line.trim();
          if (!t || t.startsWith('//')) return;
          const parts = t.split(',');
          if (parts[0] !== '9') return;
          const chan = parts[1];
          const entries = parts.slice(2);
          const data = {};
          for (let i = 0; i < entries.length; i += 2) {
            const num = entries[i];
            const key = paramMap[num];
            if (key) data[key] = entries[i+1] || '';
          }
          renderRow(chan, data);
        });
      };
      reader.readAsText(file);
    }

    // Export current table to textarea
    function exportConfig() {
      let out = '';
      document.querySelectorAll('#configBody tr').forEach(tr => {
        const chan = tr.dataset.chan;
        const parts = [];
        tr.querySelectorAll('input').forEach(inp => {
          const num = Object.entries(paramMap).find(([k,v]) => v === inp.dataset.param)[0];
          parts.push(`${num},${inp.value}`);
        });
        out += `9,${chan},${parts.join(',')}\n`;
      });
      document.getElementById('output').value = out.trim();
    }

    // Download textarea content as .log file
    function downloadConfig() {
      exportConfig();
      const content = document.getElementById('output').value;
      const blob = new Blob([content], {type:'text/plain'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'config.log';
      a.click();
      URL.revokeObjectURL(url);
    }

    // Initialize header on load
    window.onload = buildHeader;
  </script>
</body>
</html>
