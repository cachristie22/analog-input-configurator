<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IoT Channel Configuration Editor</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .controls { margin-bottom: 10px; }
    .controls input, .controls button { margin-right: 5px; }
    .container { overflow-x: auto; max-height: 70vh; margin-bottom: 10px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 5px; text-align: left; }
    input[type="text"] { width: 100%; box-sizing: border-box; }
    textarea { width: 100%; height: 120px; }
  </style>
</head>
<body>
  <h1>IoT Channel Configuration Editor</h1>
  <div class="controls">
    <input type="file" id="fileInput" accept=".log" />
    <button id="exportBtn">Export to Textarea</button>
    <button id="downloadBtn">Download .log File</button>
  </div>
  <div class="container">
    <table id="configTable">
      <thead><tr id="headerRow"></tr></thead>
      <tbody id="configBody"></tbody>
    </table>
  </div>
  <textarea id="output" placeholder="File content or exported config..."></textarea>

  <script>
    // Map of parameter indices to field names
    const paramMap = {
      1: 'name', 2: 'enable', 3: 'type', 4: 'report', 5: 'srcreg',
      6: 'scroll', 7: 'delta', 8: 'deltadeb', 9: 'pump',
      20: 'prec', 21: 'units', 30: 'bitnum', 31: 'zerolabel', 32: 'onelabel',
      98: 'id'
    };
    const allParams = Object.values(paramMap);

    // Build table header based on allParams
    function buildHeader() {
      const headerRow = document.getElementById('headerRow');
      headerRow.innerHTML = '<th>Channel</th>' +
        allParams.map(key => `<th>${key}</th>`).join('');
    }

    // Render a single channel row
    function renderRow(channel, data) {
      const tbody = document.getElementById('configBody');
      const tr = document.createElement('tr');
      tr.dataset.chan = channel;
      let rowHtml = `<td>${channel}</td>`;
      allParams.forEach(param => {
        const val = data[param] || '';
        rowHtml += `<td><input type="text" data-chan="${channel}" data-param="${param}" value="${val}" /></td>`;
      });
      tr.innerHTML = rowHtml;
      tbody.appendChild(tr);
    }

    // Import config from .log file
    function importConfig(event) {
      const input = document.getElementById('fileInput');
      const file = input.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        const text = reader.result;
        // Show raw file content
        document.getElementById('output').value = text;

        // Clear existing rows
        document.getElementById('configBody').innerHTML = '';
        buildHeader();

        // Parse and render each valid line
        text.split(/\r?\n/).forEach(line => {
          const trimmed = line.trim();
          if (!trimmed || !trimmed.startsWith('9,')) return;
          const parts = trimmed.split(',');
          const channel = parts[1];
          const entries = parts.slice(2);
          const data = {};
          for (let i = 0; i < entries.length; i += 2) {
            const num = entries[i];
            const key = paramMap[num];
            if (key) data[key] = entries[i+1] || '';
          }
          renderRow(channel, data);
        });
      };
      reader.readAsText(file);
    }

    // Export current table data to textarea
    function exportConfig() {
      let result = '';
      document.querySelectorAll('#configBody tr').forEach(tr => {
        const channel = tr.dataset.chan;
        const parts = Array.from(tr.querySelectorAll('input')).map(inp => {
          const paramNum = Object.entries(paramMap).find(([num, key]) => key === inp.dataset.param)[0];
          return `${paramNum},${inp.value}`;
        });
        result += `9,${channel},${parts.join(',')}\n`;
      });
      document.getElementById('output').value = result.trim();
    }

    // Download the textarea content as a .log file
    function downloadConfig() {
      exportConfig();
      const content = document.getElementById('output').value;
      const blob = new Blob([content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'config.log';
      a.click();
      URL.revokeObjectURL(url);
    }

    // Initialize events on DOM load
    window.addEventListener('DOMContentLoaded', () => {
      buildHeader();
      document.getElementById('fileInput').addEventListener('change', importConfig);
      document.getElementById('exportBtn').addEventListener('click', exportConfig);
      document.getElementById('downloadBtn').addEventListener('click', downloadConfig);
    });
  </script>
</body>
</html>
