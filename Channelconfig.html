<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IoT Channel Config Editor</title>
  <style>
    table {
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 4px;
      text-align: left;
    }
    input {
      width: 100%;
      box-sizing: border-box;
    }
    textarea {
      width: 100%;
      height: 200px;
      margin-top: 10px;
    }
    .container {
      overflow-x: scroll;
    }
  </style>
</head>
<body>
  <h1>IoT Channel Configuration Editor</h1>
  <div class="container">
    <table id="configTable">
      <thead>
        <tr id="headerRow"></tr>
      </thead>
      <tbody id="configBody"></tbody>
    </table>
  </div>
  <button onclick="exportConfig()">Export to Textarea</button>
  <button onclick="downloadConfig()">Download .log File</button>
  <input type="file" id="fileInput" accept=".log" onchange="importConfig(event)" />
  <textarea id="output"></textarea>

  <script>
    const paramMap = {
      1: 'name', 2: 'enable', 3: 'type', 4: 'report', 5: 'srcreg', 6: 'scroll', 7: 'delta', 8: 'deltadeb', 9: 'pump',
      20: 'prec', 21: 'units', 30: 'bitnum', 31: 'zerolabel', 32: 'onelabel', 98: 'id'
    };

    const configLines = `...` // Insert your full config data as a string here (copy all lines starting with "9,")
      .trim().split('\n');

    const allParams = Array.from(new Set(Object.values(paramMap)));

    const headerRow = document.getElementById('headerRow');
    headerRow.innerHTML = '<th>Channel</th>' + allParams.map(p => `<th>${p}</th>`).join('');

    const configBody = document.getElementById('configBody');

    function renderRow(chanNum, paramEntries) {
      const row = document.createElement('tr');
      const values = { channel: chanNum };
      for (let i = 0; i < paramEntries.length; i += 2) {
        const key = paramMap[paramEntries[i]];
        if (key) values[key] = paramEntries[i + 1];
      }
      row.innerHTML = `<td>${chanNum}</td>` + allParams.map(p =>
        `<td><input type="text" data-chan="${chanNum}" data-param="${p}" value="${values[p] || ''}" /></td>`
      ).join('');
      configBody.appendChild(row);
    }

    configLines.forEach(line => {
      const parts = line.split(',');
      if (parts[0] !== '9') return;
      const chanNum = parts[1];
      const paramEntries = parts.slice(2);
      renderRow(chanNum, paramEntries);
    });

    function exportConfig() {
      const rows = document.querySelectorAll('#configBody tr');
      let output = '';
      rows.forEach(row => {
        const chan = row.querySelector('td').innerText;
        const inputs = row.querySelectorAll('input');
        const entries = Array.from(inputs).map(input => {
          const paramNum = Object.entries(paramMap).find(([k, v]) => v === input.dataset.param)[0];
          return `${paramNum},${input.value}`;
        });
        output += `9,${chan},${entries.join(',')}\n`;
      });
      document.getElementById('output').value = output.trim();
    }

    function downloadConfig() {
      exportConfig();
      const blob = new Blob([document.getElementById('output').value], { type: 'text/plain' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'config.log';
      link.click();
    }

    function importConfig(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const lines = e.target.result.split(/\r?\n/);
        configBody.innerHTML = '';
        lines.forEach(line => {
          line = line.trim();
          if (!line || line.startsWith('//')) return; // Skip blank and comment lines
          const parts = line.split(',');
          if (parts[0] !== '9') return;
          const chanNum = parts[1];
          const paramEntries = parts.slice(2);
          renderRow(chanNum, paramEntries);
        });
      };
      reader.readAsText(file);
    }
  </script>
</body>
</html>
