<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Aquavx Pro/Pro Plus Configuration Form</title>
  <style>
    table { border-collapse: collapse; width: 100%; }
    td, th { border: 1px solid #ccc; padding: 4px; }
    input[type="text"] { width: 100%; box-sizing: border-box; }
    .controls { margin-bottom: 16px; }
    .controls > * { margin-right: 8px; }
  </style>
</head>
<body>
  <h1>Aquavx Pro/Pro Plus Configuration Form</h1>
  <div class="controls">
    <label>Load Excel: <input type="file" id="excelFile" accept=".xlsx" /></label>
    <button id="exportBtn">Export Data as JSON</button>
    <label>Import JSON: <input type="file" id="importFile" accept=".json" /></label>
  </div>
  <div id="formContainer"></div>

  <!-- SheetJS library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    let globalWorksheet;
    document.getElementById('excelFile').addEventListener('change', handleFile, false);
    document.getElementById('exportBtn').addEventListener('click', exportData, false);
    document.getElementById('importFile').addEventListener('change', importData, false);

    function handleFile(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(evt) {
        const data = new Uint8Array(evt.target.result);
        const wb = XLSX.read(data, { type: 'array' });
        const sheetName = wb.SheetNames[0];
        globalWorksheet = wb.Sheets[sheetName];
        renderForm();
      };
      reader.readAsArrayBuffer(file);
    }

    function renderForm() {
      const range = XLSX.utils.decode_range(globalWorksheet['!ref']);
      const container = document.getElementById('formContainer');
      container.innerHTML = '';
      const table = document.createElement('table');
      for (let R = range.s.r; R <= range.e.r; ++R) {
        const tr = document.createElement('tr');
        for (let C = range.s.c; C <= range.e.c; ++C) {
          const cellRef = XLSX.utils.encode_cell({r:R,c:C});
          const cell = globalWorksheet[cellRef];
          const td = document.createElement('td');
          if (cell && cell.v === 'x') {
            const input = document.createElement('input');
            input.type = 'text';
            input.dataset.address = cellRef;
            td.appendChild(input);
          } else {
            td.textContent = cell && cell.v != null ? cell.v : '';
          }
          tr.appendChild(td);
        }
        table.appendChild(tr);
      }
      container.appendChild(table);
    }

    function exportData() {
      const inputs = document.querySelectorAll('#formContainer input');
      const data = {};
      inputs.forEach(input => {
        data[input.dataset.address] = input.value;
      });
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'aquavx_form_data.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    function importData(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(evt) {
        const data = JSON.parse(evt.target.result);
        Object.entries(data).forEach(([address, value]) => {
          const input = document.querySelector(`#formContainer input[data-address='${address}']`);
          if (input) input.value = value;
        });
      };
      reader.readAsText(file);
    }
  </script>
</body>
</html>
